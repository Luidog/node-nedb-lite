(function(){"use strict";var e;(function(){e={},e.modeJs=function(){try{return typeof navigator.userAgent=="string"&&typeof document.querySelector("body")=="object"&&typeof XMLHttpRequest.prototype.open=="function"&&"browser"}catch(e){return module.exports&&typeof 
process.versions.node=="string"&&typeof require("http").createServer=="function"&&"node"}}(),e.global=e.modeJs==="browser"?window:global,e.nedb={},e.nedb.local=e})(),function(){e.nedb.assert=function(e,t){var n;if(e)return;throw n=t&&t.message?t:new Error(typeof 
t=="string"?t:JSON.stringify(t)),n},e.nedb.dbExport=function(){var t;return t="",Object.keys(e.nedb.dbTableDict).map(function(n){t+=e.nedb.dbTableDict[n].export()+"\n\n"}),t.slice(0,-2)},e.nedb.dbImport=function(t,n){t.trim().split("\n\n").forEach(function(
t){e.nedb.dbTableCreate({persistenceData:t,name:JSON.parse(/.*/.exec(t)[0])},n)})},e.nedb.dbIndexCreate=function(t,n,r){var i;e.nedb.assert(n.fieldName,n.fieldName),i=e.nedb.dbTableDict[t.name],i.indexes[n.fieldName]=new e.nedb.Index(n),n.expireAfterSeconds!==
undefined&&(i.ttlIndexes[n.fieldName]=n.expireAfterSeconds),i.indexes[n.fieldName].insert(i.crudGetAllSync()),i.save(),r()},e.nedb.dbIndexRemove=function(t,n,r){var i;i=e.nedb.dbTableDict[t.name],delete i.indexes[n.fieldName],i.save(),r()},e.nedb.dbReset=function(
t){var n,r;r={},e.nedb.onNext(r,function(i){switch(r.modeNext){case 1:n=e.nedb.onParallel(t),n.counter=0,n.counter+=1,Object.keys(e.nedb.dbTableDict).forEach(function(t){n.counter+=1,e.nedb.dbTableDict[t].drop(n)}),n.counter+=1,e.nedb.dbStorageClear(n),n();
break;default:t(i)}}),r.modeNext=0,r.onNext()},e.nedb.dbStorageClear=function(t){e.nedb.dbStorageDefer({action:"clear"},t)},e.nedb.dbStorageDefer=function(t,n){var r,i,s,o,u,a;if(!e.nedb.dbStorage){e.nedb.dbStorageDeferList.push(function(){e.nedb.dbStorageDefer
(t,n)});return}if(t.action==="onError"){n();return}switch(e.modeJs){case"browser":o=function(){if(i)return;i=!0,n(u&&(u.error||u.transaction.error),r||u.result)};switch(t.action){case"clear":case"removeItem":case"setItem":s=e.nedb.dbStorage.transaction("nedb"
,"readwrite").objectStore("nedb");break;default:s=e.nedb.dbStorage.transaction("nedb","readonly").objectStore("nedb")}switch(t.action){case"clear":u=s.clear();break;case"getItem":u=s.get(t.key);break;case"keys":r=[],u=s.openCursor(),u.onsuccess=function(){if(!
u.result){o();return}r.push(u.result.key),u.result.continue()};break;case"length":u=s.count();break;case"removeItem":u=s.delete(t.key);break;case"setItem":u=s.put(t.value,t.key)}["onabort","onerror","onsuccess"].forEach(function(e){u[e]=u[e]||o}),e.nedb._debugDbStorageRequest=
u;break;case"node":switch(t.action){case"clear":e.child_process.spawn("sh",["-c","rm "+e.nedb.dbStorage+"/*"],{stdio:["ignore",1,2]}).once("exit",function(){n()});break;case"getItem":e.nedb.assert(typeof t.key=="string",t.key),e.fs.readFile(e.nedb.dbStorage+"/"+
encodeURIComponent(t.key),"utf8",function(t,r){e.nedb.nop(t),n(null,r||"")});break;case"keys":e.fs.readdir(e.nedb.dbStorage,function(e,t){n(e,t&&t.map(decodeURIComponent))});break;case"length":e.fs.readdir(e.nedb.dbStorage,function(e,t){n(e,t&&t.length)});break;
case"removeItem":e.nedb.assert(typeof t.key=="string",t.key),e.fs.unlink(e.nedb.dbStorage+"/"+encodeURIComponent(t.key),function(){n()});break;case"setItem":e.nedb.assert(typeof t.key=="string",t.key),e.nedb.assert(typeof t.value=="string",t.value),a=e.os.tmpdir
()+"/"+Date.now()+Math.random(),e.fs.writeFile(a,t.value,function(r){e.nedb.nop(r),e.fs.rename(a,e.nedb.dbStorage+"/"+encodeURIComponent(t.key),n)})}}},e.nedb.dbStorageDeferList=[],e.nedb.dbStorageGetItem=function(t,n){e.nedb.assert(typeof t=="string"),e.nedb
.dbStorageDefer({action:"getItem",key:t},n)},e.nedb.dbStorageInit=function(){var t,n;t={},e.nedb.onNext(t,function(r){e.nedb.assert(!r,r),e.modeJs==="browser"&&(e.nedb.dbStorage=e.global.nedb_storage);switch(t.modeNext){case 1:if(e.nedb.dbStorage){t.onNext(
);return}switch(e.modeJs){case"browser":try{n=e.global.indexedDB.open("nedb"),n.onerror=t.onNext,n.onsuccess=function(){e.global.nedb_storage=n.result,t.onNext()},n.onupgradeneeded=function(){n.result.objectStoreNames.contains("nedb")||n.result.createObjectStore
("nedb")}}catch(i){}break;case"node":e.nedb.dbStorage="tmp/nedb.persistence."+e.nedb.NODE_ENV,e.child_process.spawnSync("mkdir",["-p",e.nedb.dbStorage],{stdio:["ignore",1,2]}),t.onNext()}break;case 2:while(e.nedb.dbStorageDeferList.length)e.nedb.dbStorageDeferList
.shift()()}}),t.modeNext=0,t.onNext()},e.nedb.dbStorageKeys=function(t){e.nedb.dbStorageDefer({action:"keys"},t)},e.nedb.dbStorageLength=function(t){e.nedb.dbStorageDefer({action:"length"},t)},e.nedb.dbStorageRemoveItem=function(t,n){e.nedb.assert(typeof t=="string"
),e.nedb.dbStorageDefer({action:"removeItem",key:t},n)},e.nedb.dbStorageSetItem=function(t,n,r){e.nedb.assert(typeof t=="string"),e.nedb.assert(typeof n=="string"),e.nedb.dbStorageDefer({action:"setItem",key:t,value:n},r)},e.nedb.dbTableCreate=function(t,n)
{var r;return t=e.nedb.objectSetDefault({},t),e.nedb.onNext(t,function(i,s){switch(t.modeNext){case 1:r=e.nedb.dbTableDict[t.name]=e.nedb.dbTableDict[t.name]||new e.nedb._DbTable;if(r.initialized){t.onNext();return}r.initialized=1,e.nedb.assert(t&&t.name&&typeof 
t.name=="string",t&&t.name),r.name=r.name||t.name,r.indexes={_id:new e.nedb.Index({fieldName:"_id",unique:!0}),createdAt:new e.nedb.Index({fieldName:"createdAt"}),updatedAt:new e.nedb.Index({fieldName:"updatedAt"})},r.ttlIndexes={},t.onNext();break;case 2:if(
r.initialized!==1){t.modeNext+=2,t.onNext();return}r.initialized+=1,s=(t.persistenceData||"").trim(),t.reset&&(s="undefined");if(!s){t.onNext();return}s+="\n",s=s.slice(s.indexOf("\n")+1),e.nedb.dbStorageSetItem(r.name,s,t.onNext);break;case 3:e.nedb.dbStorageGetItem
(r.name,t.onNext);break;case 4:t.dataById={},t.tdata=[],(s||"").trim().split("\n").slice(1).forEach(function(e){try{e=JSON.parse(e)}catch(n){return}e._id?e.$$deleted===!0?delete t.dataById[e._id]:t.dataById[e._id]=e:e.$$indexCreated&&e.$$indexCreated.fieldName!==
undefined?r.indexes[e.$$indexCreated.fieldName]=e.$$indexCreated:typeof e.$$indexRemoved=="string"&&delete r.indexes[e.$$indexRemoved]}),Object.keys(t.dataById).forEach(function(e){t.tdata.push(t.dataById[e])}),Object.keys(r.indexes).forEach(function(n){r.indexes
[n]=new e.nedb.Index(r.indexes[n]),r.indexes[n].reset(t.tdata)}),r.save(),t.onNext();break;default:e.nedb.assert(!i,i),n&&n(i,r)}}),t.modeNext=0,t.onNext(),r},e.nedb.dbTableDict={},e.nedb.jsonCopy=function(e){return e===undefined?undefined:JSON.parse(JSON.stringify
(e))},e.nedb.jsonStringifyOrdered=function(e,t,n){var r,i,s;return i=function(e){if(e&&typeof e=="object"&&typeof e.toJSON!="function"){if(r.indexOf(e)>=0)return;return r.push(e),Array.isArray(e)?"["+e.map(function(e){return s=i(e),typeof s=="string"?s:"null"
}).join(",")+"]":"{"+Object.keys(e).sort().map(function(t){return s=i(e[t]),typeof s=="string"?JSON.stringify(t)+":"+s:undefined}).filter(function(e){return typeof e=="string"}).join(",")+"}"}return JSON.stringify(e)},r=[],JSON.stringify(e&&typeof e=="object"?
JSON.parse(i(e)):e,t,n)},e.nedb.nop=function(){return},e.nedb.objectSetDefault=function(e,t){return e=e||{},t=t||{},Object.keys(t).forEach(function(n){t[n]!==undefined&&(e[n]=e[n]||t[n])}),e},e.nedb.onErrorDefault=function(t){t&&!e.global.__coverage__&&console
.error("\nonErrorDefault - error\n"+t.message+"\n"+t.stack+"\n")},e.nedb.onNext=function(e,t){return e.onNext=function(n,r,i){try{e.modeNext=n?Infinity:e.modeNext+1,t(n,r,i)}catch(s){if(e.errorCaught)throw e.errorCaught;e.errorCaught=s,e.onNext(s,r,i)}},e},
e.nedb.onParallel=function(t,n){var r;return n=n||e.nedb.nop,r=function(e){n(e,r);if(r.counter===0||r.error)return;e&&(r.error=e,r.counter=1),r.counter-=1,r.counter===0&&t(e)},r.counter=0,r},e.nedb.queryCompare=function(t,n,r){try{switch(t){case"$elemMatch"
:return(Array.isArray(n)?n:[]).some(function(t){return e.nedb.queryMatch(t,r)});case"$eq":return e.nedb.sortCompare(n,r)===0;case"$exists":return!(!n^!r);case"$gt":return e.nedb.sortCompare(n,r)>0;case"$gte":return e.nedb.sortCompare(n,r)>=0;case"$in":return Array
.isArray(r)&&r.some(function(t){return e.nedb.sortCompare(n,t)===0});case"$lt":return e.nedb.sortCompare(n,r)<0;case"$lte":return e.nedb.sortCompare(n,r)<=0;case"$ne":return e.nedb.sortCompare(n,r)!==0;case"$nin":return Array.isArray(r)&&r.every(function(t)
{return e.nedb.sortCompare(n,t)!==0});case"$regex":return r.test(n);case"$size":return Array.isArray(n)&&n.length===r;default:return!1}}catch(i){return e.nedb.onErrorDefault(i),!1}},e.nedb.sortCompare=function(e,t){var n,r;e===undefined&&(e=null),t===undefined&&
(t=null);if(e===t)return 0;if(e===null)return-1;if(t===null)return 1;n=typeof e,r=typeof t;if(n!==r){if(n==="boolean")return-1;if(r==="boolean")return 1;if(n==="number")return-1;if(r==="number")return 1;if(n==="string")return-1;if(r==="string")return 1}return e<
t?-1:e>t?1:0},e.nedb.isRegExp=function(e){return Object.prototype.toString.call(e)==="[object RegExp]"},e.nedb.listUnique=function(e){var t;return t={},e.filter(function(e){if(t.hasOwnProperty(e))return;return t[e]=!0,!0})}}(),function(){function i(e,t){typeof 
e=="number"&&(e=e.toString());if(!(e[0]!=="$"||e==="$$date"&&typeof t=="number"||e==="$$deleted"&&t===!0||e==="$$indexCreated"||e==="$$indexRemoved"))throw new Error("Field names cannot begin with the $ character");if(e.indexOf(".")!==-1)throw new Error("Field names cannot contain a ."
)}function s(e){Array.isArray(e)&&e.forEach(function(e){s(e)}),typeof e=="object"&&e!==null&&Object.keys(e).forEach(function(t){i(t,e[t]),s(e[t])})}function o(e){return typeof e=="boolean"||typeof e=="number"||typeof e=="string"||e===null||Array.isArray(e)}
function u(e){return function(r,i,s){var o=typeof i=="string"?i.split("."):i;if(o.length===1)n[e](r,i,s);else{if(r[o[0]]===undefined){if(e==="$unset")return;r[o[0]]={}}t[e](r[o[0]],o.slice(1),s)}}}function a(n,r){var i,o,u,a,f;i=Object.keys(r),u=i.map(function(
e){return e[0]}),o=u.filter(function(e){return e==="$"});if(i.indexOf("_id")!==-1&&r._id!==n._id)throw new Error("You cannot change a dbRow's _id");if(o.length!==0&&o.length!==u.length)throw new Error("You cannot mix modifiers and normal fields");o.length===0?
(f=e.nedb.jsonCopy(r),f._id=n._id):(a=e.nedb.listUnique(i),f=e.nedb.jsonCopy(n),a.forEach(function(e){if(!t[e])throw new Error("Unknown modifier "+e);if(typeof r[e]!="object")throw new Error("Modifier "+e+"'s argument must be an object");Object.keys(r[e]).forEach
(function(n){t[e](f,n,r[e][n])})})),s(f);if(n._id!==f._id)throw new Error("You can't change a dbRow's _id");return f}function f(e,t){var n,r,i;if(e===null||typeof e=="string"||typeof e=="boolean"||typeof e=="number"||t===null||typeof t=="string"||typeof t=="boolean"||typeof 
t=="number")return e===t;if((!Array.isArray(e)||!Array.isArray(t))&&(Array.isArray(e)||Array.isArray(t))||e===undefined||t===undefined)return!1;try{n=Object.keys(e),r=Object.keys(t)}catch(s){return!1}if(n.length!==r.length)return!1;for(i=0;i<n.length;i+=1){
if(r.indexOf(n[i])===-1)return!1;if(!f(e[n[i]],t[n[i]]))return!1}return!0}function l(e,t){var n;for(n=0;n<t.length;n+=1)e.push(t[n])}function c(e){return e===null?"$null":typeof e=="string"?"$string"+e:typeof e=="boolean"?"$boolean"+e:typeof e=="number"?"$number"+
e:Array.isArray(e)?"$date"+e.getTime():e}var t={},n={},r={};e.nedb.dbRowDeepCopy=function(t,n){var r;return typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t===null?t:Array.isArray(t)?(r=[],t.forEach(function(t){r.push(e.nedb.dbRowDeepCopy(t,n)
)}),r):typeof t=="object"?(r={},Object.keys(t).forEach(function(i){if(!n||i[0]!=="$"&&i.indexOf(".")===-1)r[i]=e.nedb.dbRowDeepCopy(t[i],n)}),r):undefined},n.$set=function(e,t,n){e[t]=n},n.$unset=function(e,t){delete e[t]},n.$push=function(e,t,n){e.hasOwnProperty
(t)||(e[t]=[]);if(!Array.isArray(e[t]))throw new Error("Can't $push an element on non-array values");n!==null&&typeof n=="object"&&n.$slice&&n.$each===undefined&&(n.$each=[]);if(n!==null&&typeof n=="object"&&n.$each){if(Object.keys(n).length>=3||Object.keys
(n).length===2&&n.$slice===undefined)throw new Error("Can only use $slice in cunjunction with $each when $push to array");if(!Array.isArray(n.$each))throw new Error("$each requires an array value");n.$each.forEach(function(n){e[t].push(n)});if(n.$slice===undefined||typeof 
n.$slice!="number")return;if(n.$slice===0)e[t]=[];else{var r,i,s=e[t].length;n.$slice<0?(r=Math.max(0,s+n.$slice),i=s):n.$slice>0&&(r=0,i=Math.min(s,n.$slice)),e[t]=e[t].slice(r,i)}}else e[t].push(n)},n.$addToSet=function(t,r,i){var s=!0;t.hasOwnProperty(r)||
(t[r]=[]);if(!Array.isArray(t[r]))throw new Error("Can't $addToSet an element on non-array values");if(i!==null&&typeof i=="object"&&i.$each){if(Object.keys(i).length>1)throw new Error("Can't use another field in conjunction with $each");if(!Array.isArray(i
.$each))throw new Error("$each requires an array value");i.$each.forEach(function(e){n.$addToSet(t,r,e)})}else t[r].forEach(function(t){e.nedb.sortCompare(t,i)===0&&(s=!1)}),s&&t[r].push(i)},n.$pop=function(e,t,n){if(!Array.isArray(e[t]))throw new Error("Can't $pop an element from non-array values"
);if(typeof n!="number")throw new Error(n+" isn't an integer, can't use it with $pop");if(n===0)return;n>0?e[t]=e[t].slice(0,e[t].length-1):e[t]=e[t].slice(1)},n.$pull=function(t,n,r){var i,s;if(!Array.isArray(t[n]))throw new Error("Can't $pull an element from non-array values"
);i=t[n];for(s=i.length-1;s>=0;s-=1)e.nedb.queryMatch(i[s],r)&&i.splice(s,1)},n.$inc=function(e,t,n){if(typeof n!="number")throw new Error(n+" must be a number");if(typeof e[t]!="number"){if(!!e.hasOwnProperty(t))throw new Error("Don't use the $inc modifier on non-number fields"
);e[t]=n}else e[t]+=n},n.$max=function(e,t,n){e[t]===undefined?e[t]=n:n>e[t]&&(e[t]=n)},n.$min=function(e,t,n){e[t]===undefined?e[t]=n:n<e[t]&&(e[t]=n)},Object.keys(n).forEach(function(e){t[e]=u(e)}),e.nedb.queryGetDotValue=function(t,n){var r,i,s;r=typeof 
n=="string"?n.split("."):n;if(!t)return undefined;if(r.length===0)return t;if(r.length===1)return t[r[0]];if(Array.isArray(t[r[0]])){i=parseInt(r[1],10);if(typeof i=="number"&&!isNaN(i))return e.nedb.queryGetDotValue(t[r[0]][i],r.slice(2));s=[];for(i=0;i<t[
r[0]].length;i+=1)s.push(e.nedb.queryGetDotValue(t[r[0]][i],r.slice(1)));return s}return e.nedb.queryGetDotValue(t[r[0]],r.slice(1))},r.$or=function(t,n){var r;if(!Array.isArray(n))throw new Error("$or operator used without an array");for(r=0;r<n.length;r+=1
)if(e.nedb.queryMatch(t,n[r]))return!0;return!1},r.$and=function(t,n){var r;if(!Array.isArray(n))throw new Error("$and operator used without an array");for(r=0;r<n.length;r+=1)if(!e.nedb.queryMatch(t,n[r]))return!1;return!0},r.$not=function(t,n){return!e.nedb
.queryMatch(t,n)},r.$where=function(e,t){var n;if(typeof t!="function")throw new Error("$where operator used without a function");n=t.call(e);if(typeof n!="boolean")throw new Error("$where function must return boolean");return n},e.nedb.queryMatch=function(
t,n){function i(t,n,r,s){var o,u,a,l,c,h;o=e.nedb.queryGetDotValue(t,n);if(Array.isArray(o)&&!s){if(Array.isArray(r))return i(t,n,r,!0);if(r!==null&&typeof r=="object"&&!e.nedb.isRegExp(r)){h=Object.keys(r).some(function(e){switch(e){case"$elemMatch":case"$size"
:return i(t,n,r,!0)}});if(h)return h}for(u=0;u<o.length;u+=1)if(i({k:o[u]},"k",r))return!0;return!1}if(r!==null&&typeof r=="object"&&!e.nedb.isRegExp(r)&&!Array.isArray(r)){a=Object.keys(r),l=a.map(function(e){return e[0]}),c=l.filter(function(e){return e==="$"
});if(c.length!==0&&c.length!==l.length)throw new Error("You cannot mix operators and normal fields");if(c.length>0)return a.every(function(t){return e.nedb.queryCompare(t,o,r[t])})}return e.nedb.isRegExp(r)?e.nedb.queryCompare("$regex",o,r):f(o,r)?!0:!1}return o
(t)||o(n)?i({needAKey:t},"needAKey",n):Object.keys(n).every(function(e){if(e[0]==="$"){if(!r[e])throw new Error("Unknown logical operator "+e);if(!r[e](t,n[e]))return}else if(!i(t,e,n[e]))return;return!0})},e.nedb.dbRowCheckObject=s,e.nedb.dbRowIsPrimitiveType=
o,e.nedb.dbRowModify=a,e.nedb.AvlTree=function(e){this.left=null,this.right=null,this.parent=e.parent!==undefined?e.parent:null,e.hasOwnProperty("key")&&(this.key=e.key),this.data=e.hasOwnProperty("value")?[e.value]:[],this.unique=e.unique||!1},e.nedb.AvlTree
.prototype.getMaxKeyDescendant=function(){return this.right?this.right.getMaxKeyDescendant():this},e.nedb.AvlTree.prototype.createSimilar=function(e){return e=e||{},e.unique=this.unique,new this.constructor(e)},e.nedb.AvlTree.prototype.createLeftChild=function(
e){var t=this.createSimilar(e);return t.parent=this,this.left=t,t},e.nedb.AvlTree.prototype.createRightChild=function(e){var t=this.createSimilar(e);return t.parent=this,this.right=t,t},e.nedb.AvlTree.prototype.insert=function(t,n){if(!this.hasOwnProperty("key"
)){this.key=t,this.data.push(n);return}if(e.nedb.sortCompare(this.key,t)===0){if(this.unique){var r=new Error("Can't insert key "+t+", it violates the unique constraint");throw r.key=t,r.errorType="uniqueViolated",r}this.data.push(n)}e.nedb.sortCompare(t,this
.key)<0?this.left?this.left.insert(t,n):this.createLeftChild({key:t,value:n}):this.right?this.right.insert(t,n):this.createRightChild({key:t,value:n})},e.nedb.AvlTree.prototype.search=function(t){return this.hasOwnProperty("key")?e.nedb.sortCompare(this.key
,t)===0?this.data:e.nedb.sortCompare(t,this.key)<0?this.left?this.left.search(t):[]:this.right?this.right.search(t):[]:[]},e.nedb.AvlTree.prototype.getLowerBoundMatcher=function(t){return!t.hasOwnProperty("$gt")&&!t.hasOwnProperty("$gte")?function(){return!0
}:t.hasOwnProperty("$gt")&&t.hasOwnProperty("$gte")?e.nedb.sortCompare(t.$gte,t.$gt)===0?function(n){return e.nedb.sortCompare(n,t.$gt)>0}:e.nedb.sortCompare(t.$gte,t.$gt)>0?function(n){return e.nedb.sortCompare(n,t.$gte)>=0}:function(n){return e.nedb.sortCompare
(n,t.$gt)>0}:t.hasOwnProperty("$gt")?function(n){return e.nedb.sortCompare(n,t.$gt)>0}:function(n){return e.nedb.sortCompare(n,t.$gte)>=0}},e.nedb.AvlTree.prototype.getUpperBoundMatcher=function(t){return!t.hasOwnProperty("$lt")&&!t.hasOwnProperty("$lte")?function(
){return!0}:t.hasOwnProperty("$lt")&&t.hasOwnProperty("$lte")?e.nedb.sortCompare(t.$lte,t.$lt)===0?function(n){return e.nedb.sortCompare(n,t.$lt)<0}:e.nedb.sortCompare(t.$lte,t.$lt)<0?function(n){return e.nedb.sortCompare(n,t.$lte)<=0}:function(n){return e.
nedb.sortCompare(n,t.$lt)<0}:t.hasOwnProperty("$lt")?function(n){return e.nedb.sortCompare(n,t.$lt)<0}:function(n){return e.nedb.sortCompare(n,t.$lte)<=0}},e.nedb.AvlTree.prototype.betweenBounds=function(e,t,n){var r=[];return this.hasOwnProperty("key")?(t=
t||this.getLowerBoundMatcher(e),n=n||this.getUpperBoundMatcher(e),t(this.key)&&this.left&&l(r,this.left.betweenBounds(e,t,n)),t(this.key)&&n(this.key)&&l(r,this.data),n(this.key)&&this.right&&l(r,this.right.betweenBounds(e,t,n)),r):[]},e.nedb.AvlTree.prototype
.deleteIfLeaf=function(){return this.left||this.right?!1:this.parent?(this.parent.left===this?this.parent.left=null:this.parent.right=null,!0):(delete this.key,this.data=[],!0)},e.nedb.AvlTree.prototype.deleteIfOnlyOneChild=function(){var e;return this.left&&!
this.right&&(e=this.left),!this.left&&this.right&&(e=this.right),e?this.parent?(this.parent.left===this?(this.parent.left=e,e.parent=this.parent):(this.parent.right=e,e.parent=this.parent),!0):(this.key=e.key,this.data=e.data,this.left=null,e.left&&(this.left=
e.left,e.left.parent=this),this.right=null,e.right&&(this.right=e.right,e.right.parent=this),!0):!1},e.nedb.AvlTree.prototype.delete=function(t,n){var r,i,s;r=[],s=this;if(!this.hasOwnProperty("key"))return;if(e.nedb.sortCompare(t,this.key)<0){this.left&&this
.left.delete(t,n);return}if(e.nedb.sortCompare(t,this.key)>0){this.right&&this.right.delete(t,n);return}if(e.nedb.sortCompare(t,this.key)!==0)return;if(this.data.length>1&&n!==undefined){this.data.forEach(function(e){e!==n&&r.push(e)}),s.data=r;return}if(this
.deleteIfLeaf())return;if(this.deleteIfOnlyOneChild())return;Math.random()>=.5?(i=this.left.getMaxKeyDescendant(),this.key=i.key,this.data=i.data,this===i.parent?(this.left=i.left,i.left&&(i.left.parent=i.parent)):(i.parent.right=i.left,i.left&&(i.left.parent=
i.parent))):(i=this.right.getMinKeyDescendant(),this.key=i.key,this.data=i.data,this===i.parent?(this.right=i.right,i.right&&(i.right.parent=i.parent)):(i.parent.left=i.right,i.right&&(i.right.parent=i.parent)))},e.nedb.AvlTree.prototype.executeOnEveryNode=
function(e){this.left&&this.left.executeOnEveryNode(e),e(this),this.right&&this.right.executeOnEveryNode(e)},e.nedb.AvlTree.prototype.balanceFactor=function(){var e=this.left?this.left.height:0,t=this.right?this.right.height:0;return e-t},e.nedb.AvlTree.prototype
.rightRotation=function(){var e=this,t=this.left,n,r,i,s;return t?(n=t.right,e.parent?(t.parent=e.parent,e.parent.left===e?e.parent.left=t:e.parent.right=t):t.parent=null,t.right=e,e.parent=t,e.left=n,n&&(n.parent=e),r=t.left?t.left.height:0,i=n?n.height:0,
s=e.right?e.right.height:0,e.height=Math.max(i,s)+1,t.height=Math.max(r,e.height)+1,t):this},e.nedb.AvlTree.prototype.leftRotation=function(){var e=this,t=this.right,n,r,i,s;return t?(n=t.left,e.parent?(t.parent=e.parent,e.parent.left===e?e.parent.left=t:e.
parent.right=t):t.parent=null,t.left=e,e.parent=t,e.right=n,n&&(n.parent=e),r=e.left?e.left.height:0,i=n?n.height:0,s=t.right?t.right.height:0,e.height=Math.max(r,i)+1,t.height=Math.max(s,e.height)+1,t):this},e.nedb.AvlTree.prototype.rightTooSmall=function(
){return this.balanceFactor()<=1?this:(this.left.balanceFactor()<0&&this.left.leftRotation(),this.rightRotation())},e.nedb.AvlTree.prototype.leftTooSmall=function(){return this.balanceFactor()>=-1?this:(this.right.balanceFactor()>0&&this.right.rightRotation
(),this.leftRotation())},e.nedb.AvlTree.prototype.rebalanceAlongPath=function(e){var t=this,n,r;if(!this.hasOwnProperty("key"))return delete this.height,this;for(r=e.length-1;r>=0;r-=1)e[r].height=1+Math.max(e[r].left?e[r].left.height:0,e[r].right?e[r].right
.height:0),e[r].balanceFactor()>1&&(n=e[r].rightTooSmall(),r===0&&(t=n)),e[r].balanceFactor()<-1&&(n=e[r].leftTooSmall(),r===0&&(t=n));return t},e.nedb.AvlTree.prototype.insert=function(t,n){var r,i=[],s=this;if(!this.hasOwnProperty("key"))return this.key=t
,this.data.push(n),this.height=1,this;for(;;){if(e.nedb.sortCompare(s.key,t)===0){if(s.unique)throw r=new Error("Can't insert key "+t+", it violates the unique constraint"),r.key=t,r.errorType="uniqueViolated",r;return s.data.push(n),this}i.push(s);if(e.nedb
.sortCompare(t,s.key)<0){if(!s.left){i.push(s.createLeftChild({key:t,value:n}));break}s=s.left}else{if(!s.right){i.push(s.createRightChild({key:t,value:n}));break}s=s.right}}return this.rebalanceAlongPath(i)},e.nedb.AvlTree.prototype.delete=function(t,n){var r=
[],i,s=this,o=[];if(!this.hasOwnProperty("key"))return this;for(;;){if(e.nedb.sortCompare(t,s.key)===0)break;o.push(s);if(e.nedb.sortCompare(t,s.key)<0){if(!s.left)return this;s=s.left}else{if(!s.right)return this;s=s.right}}if(s.data.length>1&&n)return s.data
.forEach(function(e){e!==n&&r.push(e)}),s.data=r,this;if(!s.left&&!s.right)return s===this?(delete s.key,s.data=[],delete s.height,this):(s.parent.left===s?s.parent.left=null:s.parent.right=null,this.rebalanceAlongPath(o));if(!s.left||!s.right)return i=s.left||
s.right,s===this?(i.parent=null,i):(s.parent.left===s?(s.parent.left=i,i.parent=s.parent):(s.parent.right=i,i.parent=s.parent),this.rebalanceAlongPath(o));o.push(s),i=s.left;if(!i.right)return s.key=i.key,s.data=i.data,s.left=i.left,i.left&&(i.left.parent=s
),this.rebalanceAlongPath(o);for(;;){if(!i.right)break;o.push(i),i=i.right}return s.key=i.key,s.data=i.data,i.parent.right=i.left,i.left&&(i.left.parent=i.parent),this.rebalanceAlongPath(o)},e.nedb.Index=function(e){this.fieldName=e.fieldName,this.isInteger=
e.isInteger,this.unique=e.unique||!1,this.sparse=e.sparse||!1,this.reset()},e.nedb.Index.prototype.reset=function(t){this.tree=new e.nedb.AvlTree({unique:this.unique}),t&&this.insert(t)},e.nedb.Index.prototype.insert=function(t){var n,r,i,s,o,u=this;if(Array
.isArray(t)){u.insertMultipleDocs(t);return}n=e.nedb.queryGetDotValue(t,u.fieldName);if(n===undefined&&u.sparse)return;if(u.unique&&n!==0&&!n&&u.fieldName.indexOf(".")<0){for(;;){n=u.isInteger?Math.floor(Math.random()*9007199254740992):("a"+Math.random().toString
(36).slice(2)+Math.random().toString(36).slice(2)).slice(0,16);if(!u.getMatching(n).length)break}t[u.fieldName]=n}if(!Array.isArray(n))u.tree=u.tree.insert(n,t);else{r=e.nedb.listUnique(n).map(c);for(i=0;i<r.length;i+=1)try{u.tree=u.tree.insert(r[i],t)}catch(
a){o=a,s=i;break}if(o){for(i=0;i<s;i+=1)u.tree=u.tree.delete(r[i],t);throw o}}},e.nedb.Index.prototype.insertMultipleDocs=function(e){var t,n,r;for(t=0;t<e.length;t+=1)try{this.insert(e[t])}catch(i){n=i,r=t;break}if(n){for(t=0;t<r;t+=1)this.remove(e[t]);throw n
}},e.nedb.Index.prototype.remove=function(t){var n,r=this;if(Array.isArray(t)){t.forEach(function(e){r.remove(e)});return}n=e.nedb.queryGetDotValue(t,r.fieldName);if(n===undefined&&r.sparse)return;Array.isArray(n)?e.nedb.listUnique(n).map(c).forEach(function(
e){r.tree=r.tree.delete(e,t)}):r.tree=r.tree.delete(n,t)},e.nedb.Index.prototype.update=function(e,t){if(Array.isArray(e)){this.updateMultipleDocs(e);return}this.remove(e);try{this.insert(t)}catch(n){throw this.insert(e),n}},e.nedb.Index.prototype.updateMultipleDocs=
function(e){var t,n,r;for(t=0;t<e.length;t+=1)this.remove(e[t].oldDoc);for(t=0;t<e.length;t+=1)try{this.insert(e[t].newDoc)}catch(i){r=i,n=t;break}if(r){for(t=0;t<n;t+=1)this.remove(e[t].newDoc);for(t=0;t<e.length;t+=1)this.insert(e[t].oldDoc);throw r}},e.nedb
.Index.prototype.getMatching=function(e){var t=this,n={},r=[];return Array.isArray(e)?(e.forEach(function(e){t.getMatching(e).forEach(function(e){n[e._id]=e})}),Object.keys(n).forEach(function(e){r.push(n[e])}),r):t.tree.search(e)},e.nedb.Index.prototype.getBetweenBounds=
function(e){return this.tree.betweenBounds(e)},e.nedb.Cursor=function(e,t,n){this.db=e,this.query=t||{},n&&(this.onError=n)},e.nedb.Cursor.prototype.limit=function(e){return this._limit=e,this},e.nedb.Cursor.prototype.project=function(t){var n=[],r=this,i,s
,o;return r._projection===undefined||Object.keys(r._projection).length===0?t:(i=r._projection._id===0?!1:!0,o=Object.keys(r._projection).filter(function(e){return e!=="_id"}),o.forEach(function(e){if(s!==undefined&&r._projection[e]!==s)throw new Error("Can't both keep and omit fields except for _id"
);s=r._projection[e]}),t.forEach(function(t){var r;s===1?(r={$set:{}},o.forEach(function(n){r.$set[n]=e.nedb.queryGetDotValue(t,n),r.$set[n]===undefined&&delete r.$set[n]}),r=e.nedb.dbRowModify({},r)):(r={$unset:{}},o.forEach(function(e){r.$unset[e]=!0}),r=
e.nedb.dbRowModify(t,r)),i?r._id=t._id:delete r._id,n.push(r)}),n)},e.nedb.Cursor.prototype._exec=function(t){function o(e){return s.onError?s.onError(e,n,t):t(e,n)}var n=[],r=0,i=0,s=this;s.db.getCandidates(s.query,function(t,u){var a,f,l;if(t)return o(t);
try{u.some(function(t){if(e.nedb.queryMatch(t,s.query))if(!s._sort)if(s._skip&&s._skip>i)i+=1;else{n.push(t),r+=1;if(s._limit&&s._limit<=r)return!0}else n.push(t)})}catch(c){return o(c)}s._sort&&(a=[],Object.keys(s._sort).forEach(function(e){a.push({key:e,direction
:s._sort[e]})}),n.sort(function(t,n){var r,i,s;for(s=0;s<a.length;s+=1){r=a[s],i=r.direction*e.nedb.sortCompare(e.nedb.queryGetDotValue(t,r.key),e.nedb.queryGetDotValue(n,r.key));if(i!==0)return i}return 0}),f=s._limit||n.length,l=s._skip||0,n=n.slice(l,l+f
));try{n=s.project(n)}catch(c){t=c}return o(t)})},e.nedb._DbTable=function(){return},e.nedb._DbTable.prototype.crudCountMany=function(t,n){var r,i;i=this,t=e.nedb.objectSetDefault({},t),t=e.nedb.objectSetDefault(t,{query:{}}),e.nedb.onNext(t,function(s,o){o=
o||[];switch(t.modeNext){case 1:r=0,e.nedb.dbTableCreate(i,t.onNext);break;case 2:i.getCandidates(t.query,t.onNext);break;case 3:o.forEach(function(n){e.nedb.queryMatch(n,t.query)&&(r+=1)}),t.onNext();break;default:n(s,r)}}),t.modeNext=0,t.onNext()},e.nedb.
_DbTable.prototype.crudGetAllSync=function(){var e;return e=[],this.indexes._id.tree.executeOnEveryNode(function(t){t.data.forEach(function(t){e.push(t)})}),e},e.nedb._DbTable.prototype.crudFindMany=function(t,n){var r,i,s,o,u,a,f;o=this,t=e.nedb.objectSetDefault
({},t),t=e.nedb.objectSetDefault(t,{limit:Infinity,projection:{},query:{},skip:0,sort:{}}),e.nedb.onNext(t,function(l,c){c=c||[];switch(t.modeNext){case 1:s=[],o.getCandidates(t.query,t.onNext);break;case 2:a=Object.keys(t.sort).map(function(e){return{key:e
,direction:t.sort[e]}});if(!a.length){r=t.limit,u=t.skip,c.some(function(n){if(!e.nedb.queryMatch(n,t.query))return;u-=1;if(u>=0)return;s.push(n),r-=1;if(r<=0)return!0}),t.onNext();return}s=c,s=s.filter(function(n){return e.nedb.queryMatch(n,t.query)}),s=s.
sort(function(t,n){return a.some(function(r){return f=r.direction*e.nedb.sortCompare(e.nedb.queryGetDotValue(t,r.key),e.nedb.queryGetDotValue(n,r.key)),f}),f}),s=s.slice(t.skip,t.skip+t.limit),t.onNext();break;case 4:i=Object.keys(t.projection);if(!i.list){
t.onNext();return}t.projection[i.list[0]]===1?s=s.map(function(e){return f={},i.forEach(function(t){f[t]=e[t]}),f}):s=s.map(function(e){return f={},Object.keys(e).forEach(function(n){t.projection.hasOwnProperty(n)||(f[n]=e[n])}),f}),t.onNext();break;default:
n(l,s)}}),t.modeNext=0,t.onNext()},e.nedb._DbTable.prototype.crudFindOne=function(e,t){this.crudFindMany({limit:1,query:e.query},function(e,n){t(e,n[0]||null)})},e.nedb._DbTable.prototype.crudRemoveMany=function(t,n){var r,i,s;s=this,t=e.nedb.objectSetDefault
({},t),t=e.nedb.objectSetDefault(t,{one:null,query:{}}),e.nedb.onNext(t,function(o,u){u=u||[];switch(t.modeNext){case 1:r=[],i=0,s.getCandidates(t.query,t.onNext);break;case 2:u.some(function(n){if(e.nedb.queryMatch(n,t.query)){i+=1,r.push({$$deleted:!0,_id
:n._id}),s.removeFromIndexes(n);if(t.one)return!0}}),s.save(),t.onNext();break;default:n(o,i)}}),t.modeNext=0,t.onNext()},e.nedb._DbTable.prototype.crudRemoveOne=function(t,n){t=e.nedb.objectSetDefault({},t),t=e.nedb.objectSetDefault(t,{one:!0}),this.crudRemoveMany
(t,n)},e.nedb._DbTable.prototype.drop=function(t){var n,r;r=this,n=e.nedb.onParallel(t),n.counter+=1,r.crudRemoveMany({},n),n.counter+=1,e.nedb.dbStorageRemoveItem(r.name,n)},e.nedb._DbTable.prototype.export=function(){var e,t;return t=this,e="",e+=JSON.stringify
(String(t.name))+"\n",t.crudGetAllSync().forEach(function(t){e+=JSON.stringify(t)+"\n"}),Object.keys(t.indexes).forEach(function(n){if(n==="_id")return;e+=JSON.stringify({$$indexCreated:{fieldName:n,isInteger:t.indexes[n].isInteger,unique:t.indexes[n].unique
,sparse:t.indexes[n].sparse}})+"\n"}),e.slice(0,-1)},e.nedb._DbTable.prototype.save=function(){var t;t=this;if(t.timerSave)return;t.timerSave=setTimeout(function(){delete t.timerSave,e.nedb.dbStorageSetItem(t.name,t.export(),e.nedb.onErrorDefault)},2e3),e.nedb
.dbStorageSetItem(t.name,t.export(),e.nedb.onErrorDefault)},e.nedb._DbTable.prototype.addToIndexes=function(e){var t,n,r,i=Object.keys(this.indexes);for(t=0;t<i.length;t+=1)try{this.indexes[i[t]].insert(e)}catch(s){n=t,r=s;break}if(r){for(t=0;t<n;t+=1)this.
indexes[i[t]].remove(e);throw r}},e.nedb._DbTable.prototype.removeFromIndexes=function(e){var t=this;Object.keys(this.indexes).forEach(function(n){t.indexes[n].remove(e)})},e.nedb._DbTable.prototype.updateIndexes=function(e,t){var n,r=Object.keys(this.indexes
);for(n=0;n<r.length;n+=1)this.indexes[r[n]].update(e,t)},e.nedb._DbTable.prototype.getCandidates=function(t,n){var r=this,i,s,o;s={},e.nedb.onNext(s,function(u,a){e.nedb.nop(u);switch(s.modeNext){case 1:o=[],Object.keys(t).forEach(function(e){(typeof t[e]=="string"||typeof 
t[e]=="number"||typeof t[e]=="boolean"||t[e]===null)&&o.push(e)}),o=o.filter(function(e){return r.indexes.hasOwnProperty(e)});if(o.length>0)return s.onNext(null,r.indexes[o[0]].getMatching(t[o[0]]));o=[],Object.keys(t).forEach(function(e){t[e]&&t[e].hasOwnProperty
("$in")&&o.push(e)}),o=o.filter(function(e){return r.indexes.hasOwnProperty(e)});if(o.length>0)return s.onNext(null,r.indexes[o[0]].getMatching(t[o[0]].$in));o=[],Object.keys(t).forEach(function(e){t[e]&&(t[e].hasOwnProperty("$lt")||t[e].hasOwnProperty("$lte"
)||t[e].hasOwnProperty("$gt")||t[e].hasOwnProperty("$gte"))&&o.push(e)}),o=o.filter(function(e){return r.indexes.hasOwnProperty(e)});if(o.length>0)return s.onNext(null,r.indexes[o[0]].getBetweenBounds(t[o[0]]));return s.onNext(null,r.crudGetAllSync());default:
var f=[],l=Object.keys(r.ttlIndexes);i=e.nedb.onParallel(function(e){n(e,f)}),i.counter+=1,a.forEach(function(e){var t=!0;l.forEach(function(n){e[n]!==undefined&&Date.now()>(new Date(e[n])).getTime()+r.ttlIndexes[n]*1e3&&(t=!1)}),t?f.push(e):(i.counter+=1,r
.remove({_id:e._id},{},i))}),i()}}),s.modeNext=0,s.onNext()},e.nedb._DbTable.prototype.crudInsert=function(t,n){var r,i;r=this,i=r.prepareDocumentForInsertion(t),r._insertInCache(i),setTimeout(function(){r.save(),n(null,e.nedb.jsonCopy(i))},10)},e.nedb._DbTable
.prototype.prepareDocumentForInsertion=function(t){var n,r,i=this;return Array.isArray(t)?(n=[],t.forEach(function(e){n.push(i.prepareDocumentForInsertion(e))})):(n=e.nedb.jsonCopy(t),r=(new Date).toISOString(),n.createdAt===undefined&&(n.createdAt=r),n.updatedAt===
undefined&&(n.updatedAt=r),e.nedb.dbRowCheckObject(n)),n},e.nedb._DbTable.prototype._insertInCache=function(e){Array.isArray(e)?this._insertMultipleDocsInCache(e):this.addToIndexes(e)},e.nedb._DbTable.prototype._insertMultipleDocsInCache=function(e){var t,n
,r;for(t=0;t<e.length;t+=1)try{this.addToIndexes(e[t])}catch(i){r=i,n=t;break}if(r){for(t=0;t<n;t+=1)this.removeFromIndexes(e[t]);throw r}},e.nedb._DbTable.prototype.crudUpdate=function(t,n,r,i){var s=this,o=0,u,a,f;u=r.multi!==undefined?r.multi:!1,a=r.upsert!==
undefined?r.upsert:!1,r={},e.nedb.onNext(r,function(){var l,c,h,p;switch(r.modeNext){case 1:if(!a)return r.onNext();l=new e.nedb.Cursor(s,t),l.limit(1)._exec(function(o,u){if(o)return i(o);if(u.length===1)return r.onNext();var a;try{e.nedb.dbRowCheckObject(
n),a=n}catch(f){try{a=e.nedb.dbRowModify(e.nedb.dbRowDeepCopy(t,!0),n)}catch(l){return i(l)}}return s.crudInsert(a,function(e,t){return e?i(e):i(null,1,t,!0)})});break;default:h=[],s.getCandidates(t,function(r,a){if(r)return i(r);try{for(f=0;f<a.length;f+=1
)e.nedb.queryMatch(a[f],t)&&(u||o===0)&&(o+=1,p=a[f].createdAt,c=e.nedb.dbRowModify(a[f],n),c.createdAt=p,c.updatedAt=(new Date).toISOString(),h.push({oldDoc:a[f],newDoc:c}))}catch(l){return i(l)}try{s.updateIndexes(h)}catch(l){return i(l)}var d,v;d=h.map(function(
e){return e.newDoc}),v=[],d.forEach(function(t){v.push(e.nedb.jsonCopy(t))}),setTimeout(function(){s.save(),i(null,o,v)})})}}),r.modeNext=0,r.onNext()}}();switch(e.modeJs){case"browser":e.global.nedb_lite=e.global.utility2_nedb=e.nedb,e.nedb.NODE_ENV="undefined"
;break;case"node":e.child_process=require("child_process"),e.fs=require("fs"),e.os=require("os"),module.exports=module["./lib.nedb.js"]=e.nedb,e.nedb.__dirname=__dirname,e.nedb.NODE_ENV=process.env.NODE_ENV}(function(){e.nedb.dbStorageInit()})()})()